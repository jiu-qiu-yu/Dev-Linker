# 心跳包配置独立性修复说明

## 问题描述

### 原始问题
在之前的实现中，心跳包配置的数据格式选择会意外地影响接收日志的数据格式选择。二者紧耦合在一起，导致用户体验不佳。

### 具体表现
当用户在心跳包配置中修改数据格式（字符串/十六进制）时，接收日志的数据格式选择会同步发生变化，反之亦然。这是不合理的设计，因为：
1. 心跳包的数据格式是发送端配置
2. 接收日志的数据格式是显示端配置
3. 二者应该独立设置，互不影响

## 修复方案

### 1. 添加独立的配置接口 (`src/shared/types.ts`)
```typescript
// 新增：数据交互独立配置
export interface DataInteractionConfig {
  logFormat: DataFormat  // 独立的日志显示格式
}
```

### 2. 在 Store 中添加独立配置 (`src/renderer/src/store/connection.ts`)
```typescript
// 新增独立配置
const dataInteractionConfig = ref<DataInteractionConfig>({
  logFormat: 'string'
})

// 新增更新方法
const updateDataInteractionConfig = (config: Partial<DataInteractionConfig>) => {
  dataInteractionConfig.value = { ...dataInteractionConfig.value, ...config }
  saveConfig()
}

// 更新保存逻辑，包含独立配置
const saveConfig = () => {
  const config = {
    server: serverConfig.value,
    device: deviceConfig.value,
    heartbeat: heartbeatConfig.value,
    dataInteraction: dataInteractionConfig.value  // 新增
  }
  localStorage.setItem('devlinker-config', JSON.stringify(config))
}
```

### 3. 修改数据交互组件 (`src/renderer/src/components/DataInteraction.vue`)
```typescript
// 修改前（耦合）
const logFormat = computed({
  get: () => connectionStore.heartbeatConfig.format,
  set: (value) => connectionStore.updateHeartbeatConfig({ format: value })
})

// 修改后（独立）
const logFormat = computed({
  get: () => connectionStore.dataInteractionConfig.logFormat,
  set: (value) => connectionStore.updateDataInteractionConfig({ logFormat: value })
})
```

### 4. 更新配置管理器 (`src/renderer/src/utils/config-manager.ts`)
```typescript
export interface AppConfig {
  server: ServerConfig
  device: DeviceConfig
  heartbeat: HeartbeatConfig
  dataInteraction: DataInteractionConfig  // 新增独立配置
}
```

## 修复效果

### ✅ 修复前的问题
- 心跳包格式变更 → 接收日志格式同步变化
- 无法独立设置显示格式
- 用户体验混乱

### ✅ 修复后的改进
1. **完全独立**：心跳包格式和接收日志格式现在完全独立
2. **持久化存储**：各自的格式选择会独立保存到本地存储
3. **清晰分离**：
   - 心跳包格式：控制心跳包发送时的数据格式
   - 接收日志格式：控制接收数据的显示格式
4. **互不干扰**：修改其一不会影响另一个

## 测试验证

### 测试步骤
1. 启动应用
2. 在心跳包配置中设置格式为"十六进制"
3. 在接收日志中设置格式为"字符串"
4. 确认二者格式独立，没有同步变化

### 预期结果
- 心跳包使用十六进制格式发送
- 接收日志以字符串格式显示
- 任意修改一个格式，另一个保持不变

## 技术细节

### 存储结构变化
```json
// 旧配置结构
{
  "server": {...},
  "device": {...},
  "heartbeat": {
    "enabled": false,
    "interval": 30,
    "content": "",
    "format": "string"  // 共享格式
  }
}

// 新配置结构
{
  "server": {...},
  "device": {...},
  "heartbeat": {
    "enabled": false,
    "interval": 30,
    "content": "",
    "format": "string"  // 心跳包专用格式
  },
  "dataInteraction": {
    "logFormat": "string"  // 独立的日志显示格式
  }
}
```

### 向后兼容性
- 现有用户的旧配置会被自动迁移
- 缺少 `dataInteraction` 字段的配置会自动添加默认值
- 不会影响现有功能

## 总结

此次修复彻底解决了心跳包配置与接收日志格式的耦合问题，实现了配置的独立性和清晰的功能分离。修改遵循了单一职责原则，提升了代码质量和用户体验。

**修复状态**：✅ 已完成  
**编译状态**：✅ 通过  
**影响范围**：仅配置管理，不影响核心功能
