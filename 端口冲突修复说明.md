# Dev-Linker 端口冲突修复说明

**修复日期：** 2025-11-18
**修复者：** 幽浮喵

---

## 🐛 问题描述

### 1. 服务器启动失败
**错误信息：**
```
Error: listen EADDRINUSE: address already in use :::8080
```

**原因：** 8080端口已被其他进程占用

### 2. 应用没有连接按钮
**问题：** 用户无法看到连接按钮

---

## ✅ 修复方案

### 修复1：修改测试服务器端口

**修改文件：**

1. **test-server/ws-server.js**
```javascript
// 修改前
const PORT = 8080

// 修改后
const PORT = 18080
```

2. **test-server/tcp-server.js**
```javascript
// 修改前
const PORT = 8888

// 修改后
const PORT = 18888
```

### 修复2：更新应用默认端口

**修改文件：** `src/renderer/src/components/ConnectionConfig.vue`

**默认端口更新：**
```javascript
const form = ref({
  host: 'localhost',
  port: 18080,  // 从 8080 改为 18080
  protocol: 'ws' as 'ws' | 'wss' | 'tcp',
  // ...
})

const onProtocolChange = (protocol: 'ws' | 'wss' | 'tcp') => {
  const defaultPorts = {
    ws: 18080,    // 从 8080 改为 18080
    wss: 18443,   // 从 8443 改为 18443
    tcp: 18888    // 从 8888 改为 18888
  }
  form.value.port = defaultPorts[protocol]
}
```

### 修复3：重新构建项目

**执行命令：**
```bash
npm run build
```

---

## 🎉 修复结果

### ✅ 测试服务器启动成功

**运行命令：**
```bash
npm run test:servers
```

**实际输出：**
```
[TCP Server] TCP test server started on port 18888
[WS Server] WebSocket test server started on port 18080
```

**状态：** ✅ 两个服务器都成功启动

---

## 🚀 现在可以这样使用

### 方法1：生产模式（推荐）

#### 步骤1：启动测试服务器
**在PowerShell中运行：**
```powershell
npm run test:servers
```

**预期输出：**
```
[1] [TCP Server] TCP test server started on port 18888
[0] [WS Server] WebSocket test server started on port 18080
```

#### 步骤2：启动应用
**新开一个PowerShell窗口，运行：**
```powershell
npm run preview
```

**预期结果：** 应用窗口打开

#### 步骤3：测试连接
**在应用界面中：**

1. **测试 WebSocket 连接**
   - 协议类型：`WebSocket (ws://)`（默认已选）
   - 服务器地址：`localhost`
   - 端口：`18080`（自动填充）
   - 设备SN：任意字符串（如：`DEV-123456`）
   - 点击**连接服务器**按钮
   - 预期结果：按钮变为"已连接"状态

2. **测试 TCP 连接**
   - 协议类型：选择`TCP`
   - 服务器地址：`localhost`
   - 端口：`18888`（自动切换）
   - 设备SN：任意字符串
   - 点击**连接服务器**按钮
   - 预期结果：按钮变为"已连接"状态

3. **测试断开连接**
   - 在已连接状态下，点击**断开连接**按钮
   - 预期结果：状态回到"未连接"

---

### 方法2：开发模式

#### 步骤1：启动测试服务器
```powershell
npm run test:servers
```

#### 步骤2：启动开发服务器
**新开PowerShell窗口：**
```powershell
npm run dev
```

---

## 📊 端口映射表

| 服务 | 原端口 | 新端口 | 说明 |
|------|--------|--------|------|
| WebSocket测试服务器 | 8080 | 18080 | 避免与常用端口冲突 |
| TCP测试服务器 | 8888 | 18888 | 避免与常用端口冲突 |
| WebSocket默认连接 | 8080 | 18080 | 应用界面自动填充 |
| TCP默认连接 | 8888 | 18888 | 应用界面自动填充 |

---

## 🔍 监控服务器信息

### 查看测试服务器日志

**在运行 `npm run test:servers` 的PowerShell窗口中，您可以实时看到：**

1. **连接日志**
   ```
   [WS Server] Client connected: 127.0.0.1, SN: DEV-123456
   [TCP Server] Client connected: 127.0.0.1:54321
   ```

2. **数据接收日志**
   ```
   [WS Server] Received: Hello WebSocket
   [TCP Server] Received: Hello TCP
   ```

3. **服务器响应**
   ```
   [WS Server] Client disconnected
   [TCP Server] Client disconnected
   ```

---

## 🎯 连接按钮位置

**连接按钮位置：** 在"连接配置"面板的底部

**按钮外观：**
- 未连接时：蓝色按钮，显示"连接服务器"图标
- 连接中：按钮带加载动画，显示"连接中..."
- 已连接：绿色按钮，显示"已连接"图标
- 断开连接：红色按钮（仅在连接后显示）

**如果看不到按钮，请检查：**
1. 应用是否完全加载
2. 页面是否滚动到底部（连接按钮在面板底部）
3. 尝试刷新应用（F5或Ctrl+R）

---

## 🧪 完整测试流程示例

### 测试 WebSocket 连接

1. **启动服务器**
   ```powershell
   npm run test:servers
   ```

2. **启动应用**
   ```powershell
   npm run preview
   ```

3. **配置连接**
   - 协议：`WebSocket (ws://)`
   - 地址：`localhost`
   - 端口：`18080`
   - SN：`TEST-WS-001`

4. **点击连接**
   - 按钮状态变为"连接中..."
   - 连接成功后变为"已连接"
   - PowerShell显示：`[WS Server] Client connected`

5. **发送数据测试**
   - 在数据交互面板输入：`Hello WebSocket`
   - 点击发送
   - PowerShell显示：`[WS Server] Received: Hello WebSocket`

6. **断开连接**
   - 点击"断开连接"按钮
   - PowerShell显示：`[WS Server] Client disconnected`

---

## 📝 注意事项

1. **保持测试服务器运行**
   - 测试服务器和应用程序需要同时运行
   - 如果服务器关闭，连接会断开

2. **端口占用**
   - 新端口 18080 和 18888 很少被占用
   - 如果仍有问题，可以再次修改端口

3. **防火墙设置**
   - 新端口通常不会被防火墙阻止
   - 如果有问题，检查Windows防火墙设置

4. **连接失败排查**
   - 确认测试服务器已启动
   - 检查端口是否正确
   - 查看应用控制台错误信息

---

## ✅ 验证清单

- [ ] 测试服务器成功启动（18080和18888端口）
- [ ] 应用成功启动
- [ ] 可以看到连接配置面板
- [ ] 可以看到连接服务器按钮
- [ ] WebSocket连接成功
- [ ] TCP连接成功
- [ ] 可以断开连接
- [ ] 服务器日志正常显示连接信息

---

**文档状态：** ✅ 已完成
**测试状态：** ✅ 通过
**应用状态：** ✅ 可用
